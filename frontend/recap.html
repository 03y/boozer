<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üç∫ Boozer</title>
        <link rel="stylesheet" type="text/css" href="styles/style.css" />
        <link rel="stylesheet" type="text/css" href="styles/leaderboard.css" />
        <script src="scripts/auth.js"></script>
        <style>
            .story-container {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 2rem;
            }

            .recap-wrapper {
                width: 480px;
            }

            .story-view {
                position: relative;
                width: 100%; /* Takes width of recap-wrapper */
                height: 640px;
            }

            .story-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                max-width: 100%;
                border: none;
                opacity: 0.33;
                transition: opacity 0.5s ease-in-out;
            }

            .story-progress-bars {
                display: flex;
                gap: 4px;
                padding: 0; /* Removed padding */
                box-sizing: border-box;
                margin-bottom: 8px; /* Space between bar and image */
            }

            .progress-bar {
                flex-grow: 1;
                height: 4px;
                background-color: rgba(0, 0, 0, 0.2);
            }

            .progress-bar-fill {
                height: 100%;
                width: 0;
                background-color: #333;
                transition: width 7s linear;
            }

            .story-nav {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: white;
                font-size: 3rem;
                cursor: pointer;
            }

            .story-nav.back {
                left: 10px;
            }

            .story-nav.next {
                right: 10px;
            }

            .story-text {
                position: absolute;
                top: 40px;
                left: 50%;
                transform: translateX(-50%);
                color: white;
                font-size: 1.5rem;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <nav>
            <a href="./index.html">Leaderboard</a>
            <a href="./items.html">Inventory</a>
            <a id="login-link" href="./profile.html">Profile</a>
            <a href="./submit.html">Get boozing!</a>
        </nav>

        <main>
            <div class="story-container" id="story-container">
                <div class="recap-wrapper">
                    <div
                        class="story-progress-bars"
                        id="progress-bars-container"
                    >
                        <!-- Progress bars will be generated by JavaScript -->
                    </div>
                    <div class="story-view">
                        <img
                            src=""
                            class="story-image"
                            id="story-image"
                        />
                        <p class="story-text" id="story-text"></p>
                        <button class="story-nav back" id="story-back">
                            &lt;
                        </button>
                        <button class="story-nav next" id="story-next">
                            &gt;
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <script>
            async function displayRecap() {
                const user = await getUser();

                if (!user) {
                    document.getElementById("story-container").innerHTML = "Recap not available";
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/users/${user.username}/recap`,
                    );

                    if (!response.ok) {
                        document.getElementById("story-container").innerHTML = "Recap not available";
                        return;
                    }

                    const data = await response.json();

                    console.log(data);

                } catch (error) {
                    document.getElementById("story-container").innerHTML = "Recap not available";
                    console.error(error);
                    return;
                }

                const stories = [
                    {
                        image: "images/mockup_3.jpg",
                        text: "",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 2",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 3",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 4",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 5",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 6",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 7",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 8",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 9",
                    },
                    {
                        image: "images/mockup_3.jpg",
                        text: "card 10",
                    },
                ];

                let currentStoryIndex = 0;
                let storyTimer;
                let isInitialLoad = true;

                const progressBarsContainer = document.getElementById(
                    "progress-bars-container",
                );
                const storyImage = document.getElementById("story-image");
                const storyText = document.getElementById("story-text");
                const backButton = document.getElementById("story-back");
                const nextButton = document.getElementById("story-next");

                const initStories = () => {
                    progressBarsContainer.innerHTML = "";
                    stories.forEach(() => {
                        const progressBar = document.createElement("div");
                        progressBar.className = "progress-bar";
                        const progressBarFill = document.createElement("div");
                        progressBarFill.className = "progress-bar-fill";
                        progressBar.appendChild(progressBarFill);
                        progressBarsContainer.appendChild(progressBar);
                    });
                    showStory(0);
                };

                const showStory = (index) => {
                    if (index < 0 || index >= stories.length) return;
                    clearTimeout(storyTimer);

                    const fadeDuration = 500; // Must match CSS transition duration

                    const updateContent = () => {
                        currentStoryIndex = index;
                        storyImage.src = stories[index].image;
                        storyText.textContent = stories[index].text;

                        const allProgressFills =
                            progressBarsContainer.querySelectorAll(
                                ".progress-bar-fill",
                            );

                        allProgressFills.forEach((fill, i) => {
                            fill.style.transition = "none";
                            if (i < index) {
                                fill.style.width = "100%";
                            } else {
                                fill.style.width = "0";
                            }
                        });

                        // Force a DOM reflow to ensure the opacity transition triggers correctly
                        void storyImage.offsetHeight;

                        storyImage.style.opacity = 1; // Fade in

                        // We use a timeout to allow the browser to apply the initial width before starting the transition.
                        setTimeout(() => {
                            const currentFill = allProgressFills[index];
                            currentFill.style.transition = "width 20s linear"; // TODO: change duration
                            currentFill.style.width = "100%";
                        }, 50);

                        storyTimer = setTimeout(playNextStory, 20050); // 20s for story + 50ms buffer TODO: change duration
                    };

                    if (isInitialLoad) {
                        isInitialLoad = false;
                        updateContent();
                    } else {
                        storyImage.style.opacity = 0.33;
                        setTimeout(updateContent, fadeDuration);
                    }
                };

                const playNextStory = () => {
                    if (currentStoryIndex < stories.length - 1) {
                        showStory(currentStoryIndex + 1);
                    }
                };

                const playPreviousStory = () => {
                    if (currentStoryIndex > 0) {
                        showStory(currentStoryIndex - 1);
                    }
                };

                backButton.addEventListener("click", playPreviousStory);
                nextButton.addEventListener("click", playNextStory);

                initStories();
            }

            document.addEventListener("DOMContentLoaded", displayRecap());
        </script>
    </body>
</html>
